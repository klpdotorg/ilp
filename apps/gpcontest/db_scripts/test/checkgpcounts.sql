select data.qgid, data1.numstu, sum(case when percentage<=35 then 1 end) as per35, sum(case when percentage<=60 and percentage>35 then 1 end) as per35_60,  sum(case when percentage>60 and percentage<=75  then 1 end)as per61_70, sum(case when percentage>75 then 1 end) as perc75 from (select distinct ag.questiongroup_id qgid, ag.id agid, sum(ans.answer::int)*100/20 percentage  from assessments_answergroup_institution ag, assessments_answerinstitution ans where ans.answergroup_id=ag.id and ag.questiongroup_id in (select id from assessments_questiongroup where survey_id =2) and ag.institution_id in (select id from schools_institution where gp_id =741) and ans.question_id not in (291,130) group by ag.questiongroup_id, ag.id)data, (select distinct ag.questiongroup_id qgid, count(distinct ag.id)  as numstu from assessments_answergroup_institution ag where ag.questiongroup_id in (select id from assessments_questiongroup where survey_id =2) and ag.institution_id in (select id from schools_institution where gp_id =741) group by ag.questiongroup_id )data1 where data.qgid=data1.qgid group by data.qgid,data1.numstu;


select data.key, data.qgid, data1.numstu, count(data.agid), (count(data.agid)*100)/data1.numstu from (select distinct qmap.key as key, ag.questiongroup_id as qgid, qmap.max_score, ag.id as agid, sum(ans.answer::int) as answer from assessments_competencyquestionmap qmap, assessments_answergroup_institution ag, assessments_answerinstitution ans where ag.id=ans.answergroup_id and ag.questiongroup_id=qmap.questiongroup_id and ans.question_id=qmap.question_id and ag.institution_id in (select id from schools_institution where gp_id =741) group by qmap.key, ag.questiongroup_id, qmap.max_score,ag.id having sum(ans.answer::int)>=sum(qmap.max_score))data,(select distinct ag.questiongroup_id qgid, count(distinct ag.id)  as numstu from assessments_answergroup_institution ag where ag.questiongroup_id in (select id from assessments_questiongroup where survey_id =2) and ag.institution_id in (select id from schools_institution where gp_id =741) group by ag.questiongroup_id )data1 where data.qgid=data1.qgid group by data.key,data.qgid, data1.numstu order by data.qgid;


