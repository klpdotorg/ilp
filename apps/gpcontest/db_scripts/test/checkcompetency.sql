select data.dateofvisit, data.qgid, data.instid, data.key, data1.numstu, count(data.agid), (count(data.agid)*100)/data1.numstu from  (select distinct to_char(ag.date_of_visit,'DD/MM/YYYY') as dateofvisit, ag.institution_id as instid, ag.questiongroup_id as qgid, qmap.key as key, ag.id as agid, sum(ans.answer::int) as answer from assessments_competencyquestionmap qmap, assessments_answergroup_institution ag, assessments_answerinstitution ans where ag.id=ans.answergroup_id and ag.questiongroup_id=qmap.questiongroup_id and ans.question_id=qmap.question_id and ag.institution_id in (:institution_id) and ag.questiongroup_id in (select id from assessments_questiongroup where survey_id=2) and to_char(ag.date_of_visit,'YYYYMM')::int>= :startyearmonth and to_char(ag.date_of_visit,'YYYYMM')::int<= :endyearmonth group by ag.date_of_visit, qmap.key, ag.questiongroup_id, qmap.max_score,ag.id, ag.institution_id having sum(ans.answer::int)>=sum(qmap.max_score))data,(select distinct to_char(ag.date_of_visit,'DD/MM/YYYY') as dateofvisit, ag.questiongroup_id qgid, count(distinct ag.id)  as numstu from assessments_answergroup_institution ag where ag.questiongroup_id in (select id from assessments_questiongroup where survey_id =2) and ag.institution_id in (:institution_id) and to_char(ag.date_of_visit,'YYYYMM')::int>= :startyearmonth and to_char(ag.date_of_visit,'YYYYMM')::int<= :endyearmonth group by ag.questiongroup_id, ag.date_of_visit )data1 where data.qgid=data1.qgid and data.dateofvisit=data1.dateofvisit group by data.qgid, data.instid, data.key, data1.numstu, data.dateofvisit having (count(data.agid)*100)/data1.numstu <60;
