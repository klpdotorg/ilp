{% extends 'backoffice/base.html' %}

{% block content %}
    <form action="" method="post">
        {% csrf_token %}
        {{ form_errors }}
        <label>Select State</label>
          <select id="sel_state" name="state" class="form-control">
            <option value="">Select State</option>                    
            {% for state in states %}
              <option id="{{ state.char_id }}" value="{{ state.char_id }}">
                    {{ state.boundary.name }}
              </option>
            {% endfor %}
           </select>

        <label>Select Survey</label>
          <select id="sel_survey" name="survey" class="form-control">
            <option value="">Select Survey</option>                    
            {% for survey in surveys %}
              <option id="{{ survey.id }}" value="{{ survey.id }}">
                    {{ survey.name }}
              </option>
            {% endfor %}
           </select>

        <label>Select District</label>
          <select id="sel_district" name="district" class="form-control">
            <option value="">Select District</option>                    
            {% for admin1 in admin1s %}
              <option id="{{ admin1.id }}" value="{{ admin1.id }}">
                    {{ admin1.name }}
              </option>
            {% endfor %}
           </select>
       
        <label>Select Block</label>
          <select id="sel_block" name="block" class="form-control">
            <option value="">Select Block</option>                    
          </select>
      
        <label>Select Cluster</label>
          <select id="sel_cluster" name="cluster" class="form-control">
            <option value="">Select Cluster</option>                    
          </select>

        <label>Select School</label>
          <select id="sel_school" name="school" class="form-control">
            <option value="">Select School</option>                    
          </select>

        <label>Select Year</label>
          <select id="sel_year" name="year" class="form-control">
            <option value="">Select Year</option>                    
            {% for y in year %}
              <option id="{{ y }}" value="{{ y }}">
                    {{ y }}
              </option>
            {% endfor %}
          </select>

        <label>Select Month</label>
          <select id="sel_month" name="month" class="form-control">
            <option value="">Select Month</option>                    
            {% for key, val in month.items %}
              <option id="{{ key }}" value="{{ key }}">
                    {{ val }}
              </option>
            {% endfor %}
          </select>

        <div class="row">
            <hr>
        </div>

        <input class="btn btn-info" type="submit" value="Download">
        <button class="btn" value="Reset" onClick="window.location.reload()">Reset</button>

        <div class="row">
            <hr>
        </div>
    </form>
{% endblock content %}

{% block extra_js %}
    <script>
        $('select[name=state]').change(function(){
            state_id = $(this).val();
            request_url = '/api/v1/surveys/?state=' + state_id;
                $.ajax({
                    url: request_url,
                    dataType: "json",
                    success: function(data){
                        results = data['results'];
                        $('select[name=survey]').empty();
                        $('select[name=survey]').append($('<option>', {value:"", text: "Select Survey"}));
                        $.each(results, function(index, item){
                            $('select[name=survey]').append($('<option>', {value:item['id'], text:item['name']}));
                        });
                    }
                })
            request_url = '/api/v1/boundary/admin1s/?state=' + state_id;
                $.ajax({
                    url: request_url,
                    dataType: "json",
                    success: function(data){
                        results = data['results'];
                        $('select[name=district]').empty();
                        $('select[name=district]').append($('<option>', {value:"", text: "Select District"}));
                        $.each(results, function(index, item){
                            $('select[name=district]').append($('<option>', {value:item['id'], text:item['name']}));
                        });
                    }
                })
            }
        );

        $('select[name=district]').change(function(){
            district_id = $('select[name=state]').val();
                $.ajax({
                    url: request_url,
                    dataType: "json",
                    success: function(data){
                        results = data['results'];
                        $('select[name=block]').empty();
                        $('select[name=block]').append($('<option>', {value:"", text: "Select Block"}));
                        $.each(results, function(index, item){
                            $('select[name=block]').append($('<option>', {value:item['id'], text:item['name']}));
                        });
                    }
                })
            }
        );   
        $('select[name=block]').change(function(){
            block_id = $(this).val();
            request_url = '/api/v1/boundary/admin2/' + block_id + '/admin3/?survey_tag=gka';
                $.ajax({
                    url: request_url,
                    dataType: "json",
                    success: function(data){
                        results = data['results'];
                        $('select[name=cluster]').empty();
                        $('select[name=cluster]').append($('<option>', {value:"", text: "Select Cluster"}));
                        $.each(results, function(index, item){
                            $('select[name=cluster]').append($('<option>', {value:item['id'], text:item['name']}));
                        });
                    }
                })
            }
        );
        $('select[name=cluster]').change(function(){
            cluster_id = $(this).val();
            request_url = '/api/v1/surveys/institution/?boundary_id=' + cluster_id;
                $.ajax({
                    url: request_url,
                    dataType: "json",
                    success: function(data){
                        results = data['results'];
                        $('select[name=school]').empty();
                        $('select[name=school]').append($('<option>', {value:"", text: "Select School"}));
                        $.each(results, function(index, item){
                            $('select[name=school]').append($('<option>', {value:item['id'], text:item['name']}));
                        });
                    }
                })
            }
        );

        $('form').submit(function () {
            var state = $('select[name=state]').val();
            var survey = $('select[name=survey]').val();
            var year = $('select[name=year]').val();
            var month = $('select[name=month]').val();

            if (!state || !survey || !year || !month) {
                alert("Please check - State, Survey, Year, Month is filled.");
                return false
            }
        });
    </script>
{% endblock extra_js %}